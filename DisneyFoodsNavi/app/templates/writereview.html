{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}レビュー投稿{% endblock %}</title>
    {% block head %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #foodResults {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
    {% endblock %}
</head>
<body>
{% block content %}
    <div class="container mt-5">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- レビュー投稿フォーム -->
            <div class="mb-3">
                <label for="id_food_display" class="form-label">商品名</label>
                <!-- ユーザーが選択した商品名を表示するフィールド -->
                <input type="text" id="food_display" class="form-control" placeholder="商品名を選択してください" readonly>
                <!-- フォームに送信される隠しフィールド -->
                {{ review_form.food }}
                <!-- 子ウィンドウ起動ボタン -->
                <button type="button" class="btn btn-outline-primary mt-2" id="openFoodSearch">
                    商品名を選択
                </button>
            </div>

            <!-- 利用した店舗 -->
            <div class="mb-3">
                <label for="{{ review_form.store.id_for_label }}" class="form-label">利用した店舗</label>
                {{ review_form.store }}
            </div>

            <!-- 評価 -->
            <div class="mb-3">
                <label for="{{ review_form.rating.id_for_label }}" class="form-label">評価(5点満点)</label>
                {{ review_form.rating }}
            </div>
        
            <!-- 画像アップロードフォーム -->
            <div class="mb-3">
                <label for="id_review_image_path">画像</label>
                {{ images_formset.management_form }}  <!-- フォームセットの管理フォーム -->                 
                
                {% for form in images_formset %}
                    <div class="image-upload">
                        {{ form.review_image_path }}
                    </div>
                {%  endfor %}
            </div>

            <!-- レビュー -->
            <div class="mb-3">
                <label for="{{ review_form.comment.id_for_label }}" class="form-label">レビュー（400文字以内）</label>
                {{ review_form.comment }}
            </div>
        
            <button type="submit" class="btn btn-primary">投稿する</button>
        </form>

        <a href="{% url 'home' %}" class="btn btn-secondary mt-3">ホーム画面へ</a>
    </div>

    <!-- 商品検索モーダル -->
    <div class="modal fade" id="foodModal" tabindex="-1" aria-labelledby="foodModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="foodModalLabel">商品名を検索</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="foodSearch" class="form-control" placeholder="商品名を検索">
                    <ul id="foodResults" class="list-group mt-3"></ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const imageInput = document.querySelector("#id_review_image_path");
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");
    
    if(imageInput) {
        imageInput.addEventListener("change", function(event) {
            // 選択されたファイルを取得
            const files = event.target.files;

            // `files`が存在しない、または空なら処理を終了
            if (!files || files.length === 0) return;

            // ファイルごとに処理
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    // 画像表示用のdivを作成
                    const previewDiv = document.createElement("div");
                    previewDiv.style.position = "relative";
                    previewDiv.style.display = "inline-block";
                    previewDiv.style.margin = "5px";

                    // 画像要素
                    const image = document.createElement("img");
                    image.src = e.target.result;
                    image.style.width ="80px";
                    image.style.height = "80px";
                    image.style.objectFit = "contain";

                    // 削除ボタン
                    const removeButton = document.createElement("button");
                    removeButton.innerText = "x";
                    removeButton.style.position = "absolute";
                    removeButton.style.top = "-5px";
                    removeButton.style.right = "-5px";
                    removeButton.style.background = "red";
                    removeButton.style.color = "white";
                    removeButton.style.border = "none";
                    removeButton.style.borderRadius = "50%";
                    removeButton.style.width = "20px";
                    removeButton.style.height = "20px";
                    removeButton.style.fontSize = "14px";
                    removeButton.style.cursor = "pointer";

                    // 削除ボタンのクリックで画像を削除
                    removeButton.addEventListener("click", function() {
                        previewDiv.remove();  // 画像を削除
                    });

                    // 要素を追加
                    previewDiv.appendChild(image);
                    previewDiv.appendChild(removeButton);
                    imagePreviewContainer.appendChild(previewDiv);
                };

                reader.readAsDataURL(file);
            });
        });
    }
});
</script>

<script src="{% static 'js/main.js' %}"></script>
{% endblock %}

</body>
</html>