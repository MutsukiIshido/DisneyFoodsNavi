{% extends 'base.html' %}
{% load static %}


{% block title %}ãƒãƒƒãƒ—ï¼ˆæ¤œç´¢çµæœï¼‰{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    {{ block.super }}  <!-- base.htmlã®headãƒ–ãƒ­ãƒƒã‚¯ã‚’å¼•ãç¶™ã -->
    <style>
        /* ãƒãƒƒãƒ—ã¨ãƒªã‚¹ãƒˆã‚’æ¨ªä¸¦ã³ã«é…ç½® */
        .map-container {
            display: flex;
            height: 80vh;  /* ç”»é¢ã®80ï¼…ã®é«˜ã• */
        }

        #map {
            width: 50%;
            height: 100%;
        }

        .store-list {
            width: 50%;
            height: 100%;
            overflow-y: auto; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
            padding: 10px;
            background-color: #f9f9f9;
        }

        .store-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .store-item.active {
            background-color: #ffeeba;   /* ãƒ”ãƒ³é¸æŠæ™‚ã®å¼·èª¿è¡¨ç¤º */
        }

        .rating-stars {
            font-size: 14px;
            color: #FFD700;
        }

        /* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  */
        .search-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            background-color: #eee;
        }

        .search-container input {
            padding: 5px;
            width: 150px;
        }

        .search-container select {
            padding: 5px;
            width: 180px;
            max-width: 250px;
        }

        .search-container button {
            padding: 10px 20px;
            width: 150px; /* â† æ¨ªå¹…ã‚’é•·ãã™ã‚‹ï¼ˆã“ã“ã‚’å¥½ããªå€¤ã«å¤‰ãˆã¦OKï¼‰ */
            font-size: 16px;
            border-radius: 5px;
            background-color: #d2935c9a;
            color: #81400c;
            border: none;
            cursor: pointer;
        }

        .park-select {
            display: flex;         /* æ¨ªä¸¦ã³ã«ã™ã‚‹ */
            gap: 5px;             /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³åŒå£«ã®é–“éš” */
            align-items: center;   /* ç¸¦æ–¹å‘ã‚‚ä¸­å¤®æƒãˆ */
        }

        .park-select label {
            display: flex;
            align-items: center;
            gap: 5px;  /* â† ã¡ã‚‡ã£ã¨ã ã‘é–‹ã‘ã‚‹ */
            font-size: 14px;
        }

        .park-select label input[type="radio"] {
            width: 30px;    /* â† å¹…ã‚’æŒ‡å®š */
            height: 16px;   /* â† é«˜ã•ã‚‚çµ±ä¸€ */
            margin: 0;      /* â† ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
            vertical-align: middle; /* â† ãƒ†ã‚­ã‚¹ãƒˆã¨é«˜ã•ã‚’åˆã‚ã›ã‚‹ */
        }


    </style>
{% endblock%}

{% block content %}
    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="search-form" method="get" action="{% url 'map' %}">
        <div class="search-container">
            <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ -->
            <input type="text" id="food-name" placeholder="ãƒ•ãƒ¼ãƒ‰åã‚’å…¥åŠ›">
            
            <!-- ã‚«ãƒ†ã‚´ãƒª -->
            <select id="category" name="category">
                <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
                <option value="10" {% if category == "10" %}selected{% endif %}>ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒƒã‚·ãƒ¥</option>
                <option value="11" {% if category == "11" %}selected{% endif %}>è»½é£Ÿ</option>
                <option value="12" {% if category == "12" %}selected{% endif %}>ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼</option>
                <option value="13" {% if category == "13" %}selected{% endif %}>ã‚­ãƒƒã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼</option>
                <option value="14" {% if category == "14" %}selected{% endif %}>ãƒ‡ã‚¶ãƒ¼ãƒˆ</option>
                <option value="15" {% if category == "15" %}selected{% endif %}>ãƒ‰ãƒªãƒ³ã‚¯</option>
                <option value="16" {% if category == "16" %}selected{% endif %}>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒ‰ãƒªãƒ³ã‚¯</option>
            </select>

            <!-- ä¾¡æ ¼å¸¯ -->
            <select name="price_range" id="price-range">
                <option value="">ä¾¡æ ¼å¸¯ã‚’é¸æŠ</option>
                <option value="0" {% if price_range == "0" %}selected{% endif %}>~500å††</option>
                <option value="1" {% if price_range == "1" %}selected{% endif %}>500å††~1000å††</option>
                <option value="2" {% if price_range == "2" %}selected{% endif %}>1000å††~1500å††</option>
                <option value="3" {% if price_range == "3" %}selected{% endif %}>1500å††~2000å††</option>
                <option value="4" {% if price_range == "4" %}selected{% endif %}>2000å††ä»¥ä¸Š</option>
            </select>

            <!-- ã‚¨ãƒªã‚¢ -->
            <select name="area" id="area">
                <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                <option value="ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒã‚¶ãƒ¼ãƒ«" {% if area == "ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒã‚¶ãƒ¼ãƒ«" %} selected {% endif %}>ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒã‚¶ãƒ¼ãƒ«</option>
                <option value="ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰" {% if area == "ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰" %} selected {% endif %}>ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ©ãƒ³ãƒ‰</option>
                <option value="ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰" {% if area == "ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰" %} selected {% endif %}>ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰</option>
                <option value="ã‚¯ãƒªãƒƒã‚¿ãƒ¼ã‚«ãƒ³ãƒˆãƒªãƒ¼" {% if area == "ã‚¯ãƒªãƒƒã‚¿ãƒ¼ã‚«ãƒ³ãƒˆãƒªãƒ¼" %} selected {% endif %}>ã‚¯ãƒªãƒƒã‚¿ãƒ¼ã‚«ãƒ³ãƒˆãƒªãƒ¼</option>
                <option value="ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰" {% if area == "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰" %} selected {% endif %}>ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰</option>
                <option value="ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³" {% if area == "ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³" %} selected {% endif %}>ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³</option>
                <option value="ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰" {% if area == "ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰" %} selected {% endif %}>ãƒˆã‚¥ãƒ¢ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰</option>
                <option value="ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼" {% if area == "ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼" %} selected {% endif %}>ãƒ¡ãƒ‡ã‚£ãƒ†ãƒ¬ãƒ‹ã‚¢ãƒ³ãƒãƒ¼ãƒãƒ¼</option>
                <option value="ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ" {% if area == "ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ" %} selected {% endif %}>ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ</option>
                <option value="ãƒãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼" {% if area == "ãƒãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼" %} selected {% endif %}>ãƒãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼</option>
                <option value="ãƒ­ã‚¹ãƒˆãƒªãƒãƒ¼ãƒ‡ãƒ«ã‚¿" {% if area == "ãƒ­ã‚¹ãƒˆãƒªãƒãƒ¼ãƒ‡ãƒ«ã‚¿" %} selected {% endif %}>ãƒ­ã‚¹ãƒˆãƒªãƒãƒ¼ãƒ‡ãƒ«ã‚¿</option>
                <option value="ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹" {% if area == "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹" %} selected {% endif %}>ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¹</option>
                <option value="ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ" {% if area == "ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ" %} selected {% endif %}>ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ã‚³ãƒ¼ã‚¹ãƒˆ</option>
                <option value="ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³" {% if area == "ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³" %} selected {% endif %}>ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ©ã‚°ãƒ¼ãƒ³</option>
                <option value="ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰" {% if area == "ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰" %} selected {% endif %}>ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰</option>
            </select>
            
            <!-- ãƒ‘ãƒ¼ã‚¯é¸æŠï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰ -->
            <div class="park-select">
                <label><input type="radio" name="park" value="0" {% if park == "0" %}checked{% endif %}> ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰</label>
                <label><input type="radio" name="park" value="1" {% if park == "1" %}checked{% endif %}> ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚·ãƒ¼</label>
                <label><input type="radio" name="park" value="all" {% if park == "all" or not park %}checked{% endif %}> ä¸¡ãƒ‘ãƒ¼ã‚¯</label>
            </div>
            
            <button id="search-button">æ¤œç´¢</button>
        </div>
    </form>

    <!-- ãƒãƒƒãƒ—ã¨ãƒªã‚¹ãƒˆ -->
    <div class="map-container">
        <!-- ãƒãƒƒãƒ—éƒ¨åˆ† -->
        <div id="map"></div>
        <!-- åº—èˆ—ä¸€è¦§éƒ¨åˆ† -->
        <div class="store-list" id="store-list">
            <div id="no-results" style="display: none; color: gray; text-align: center; margin-top: 20px;">
                æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
            </div>
        </div>
    </div>
    
    <!-- JSOnãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿ -->
    {{ stores|json_script:"stores-data" }}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var storesDataElement = document.getElementById("stores-data");

            if (!storesDataElement) {
                console.error("stores-data è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
                return;  // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å‡¦ç†ã‚’ä¸­æ–­
            }

            try {
                var storesJson = storesDataElement.textContent.trim();
                var stores = JSON.parse(storesDataElement.textContent);
                console.log("stores:", stores); // â† ã“ã“ã§ category_id ãŒã‚ã‚‹ã‹ç¢ºèª

                console.log("stores ãƒ‡ãƒ¼ã‚¿:", stores);  // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
            } catch (error) {
                console.error("JSON ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", error);
                return;
            }

            // --- ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ stores ãŒæ­£ã—ãå–å¾—ã§ããŸå¾Œã«å®Ÿè¡Œ ---
            var map = L.map('map').setView([35.6329, 139.8804], 15);       
  
            // OpenStreetMapã‚’åˆ©ç”¨
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            var markers = [];
            var storeList = document.getElementById("store-list");

            function updateMap(filteredStores) {
                markers.forEach(m => map.removeLayer(m.marker));  // æ—¢å­˜ãƒ”ãƒ³å‰Šé™¤
                storeList.innerHTML = "";  // ãƒªã‚¹ãƒˆåˆæœŸåŒ–
                markers = [];

                // æ¤œç´¢çµæœãªã—ã®è¡¨ç¤ºç”¨è¦ç´ ã‚’ã“ã“ã§æ–°ãŸã«ä½œã‚Šç›´ã™
                const noResults = document.createElement("div");
                noResults.id = "no-results";
                noResults.style.display = "none";
                noResults.style.color = "gray";
                noResults.style.textAlign = "center";
                noResults.style.marginTop = "20px";
                noResults.textContent = "æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";

                // ğŸ”¸storeList ã«æœ€åˆã«è¿½åŠ ã—ã¦ãŠãï¼ˆã‚ã£ã¦ã‚‚ãªãã¦ã‚‚OKãªã‚ˆã†ã«ï¼‰
                storeList.appendChild(noResults);

                if (filteredStores.length === 0) {
                    noResults.style.display = "block";
                    return;
                } else {
                    noResults.style.display = "none";
                }

                // é€šå¸¸ã®ãƒ”ãƒ³ï¼†ãƒªã‚¹ãƒˆç”Ÿæˆå‡¦ç†
                filteredStores.forEach((store, index) => {
                    var marker = L.marker([store.latitude, store.longitude])
                        .addTo(map)
                        .bindPopup(`<strong>${store.store_name}</strong><br>${store.food_name}<br>è©•ä¾¡: ${store.rating}â­ï¸<br>ä¾¡æ ¼: Â¥${store.price}`);

                    markers.push({ marker: marker, index:index });

                    marker.on("click", function() {
                        highlightStore(index);
                    });

                    var storeItem = document.createElement("div");
                    storeItem.classList.add("store-item");
                    storeItem.id = "store-" + index;
                    storeItem.dataset.index = index;
                    storeItem.innerHTML = `
                        <div class="store-info">
                            <img src="${store.image_path}" alt="${store.food_name}" class="store-image">
                            <div class="store-details">
                            <strong>${store.store_name}</strong><br>
                            <a href="/food/${store.food_id}/">${store.food_name}</a><br>
                            <span>Â¥${store.price}</span> | 
                            <span class="rating-stars">${store.rating} ${"â­ï¸".repeat(Math.round(store.rating))}</span>
                            </div>
                        </div>
                    `;
                    storeItem.addEventListener("click", function() {
                        marker.openPopup();
                        map.setView(marker.getLatLng(), 17);
                        highlightStore(index);
                    });

                    storeList.appendChild(storeItem);
                });
            }


            console.log("Filtered stores:", filteredStores);

            function highlightStore(index) {
                document.querySelectorAll(".store-item").forEach(item => item.classList.remove("active"));
                var selectedItem = document.getElementById("store-" + index);
                selectedItem.classList.add("active");
                selectedItem.scrollIntoView({ behavior: "smooth", block: "center"});
            }

            function filteredStores() {
                var keyword = document.getElementById("food-name").value.toLowerCase().trim();
                var category = document.getElementById("category").value;
                var priceRange = document.getElementById("price-range").value;
                var area = document.getElementById("area").value.trim();
                var park = document.querySelector('input[name="park"]:checked')?.value;
                
                console.log("é¸æŠä¸­ park:", park);
                console.log("é¸æŠä¸­ category:", category);
                console.log("é¸æŠä¸­ priceRange:", priceRange);
                console.log("é¸æŠä¸­ area:", area);

                let filteredStores = [];

                try {
                    filteredStores = stores.filter(store => {
                        console.log("store.area:", store.area, "ï½œ area:", area);  // ã“ã“ã§ undefined ã‹ç¢ºèªï¼

                        var matchKeyword = !keyword || (store.food_name && store.food_name.toLowerCase().includes(keyword));
                        var matchCategory = !category || store.category_id === category;

                        var matchPrice = true;
                        var price = parseInt(store.price);
                        if (priceRange === "0") {
                            matchPrice = price <= 500;
                        } else if (priceRange === "1") {
                            matchPrice = price > 500 && price <= 1000;
                        } else if (priceRange === "2") {
                            matchPrice = price > 1000 && price <= 1500;
                        } else if (priceRange === "3") {
                            matchPrice = price > 1500 && price <= 2000;
                        } else if (priceRange === "4") {
                            matchPrice = price > 2000;
                        }

                        // âš ï¸ store.area ãŒå­˜åœ¨ã—ãªã„ã¨ .trim() ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ && ãƒã‚§ãƒƒã‚¯
                        var matchArea = !area || (store.area && store.area.trim() === area);

                        // ğŸ”½ park ã§ã®çµã‚Šè¾¼ã¿
                        var matchPark = (park === "all") || (store.park !== undefined && String(store.park) === park);

                        return matchKeyword && matchCategory && matchPrice && matchArea && matchPark;
                    });

                    console.log("Filtered result:", filteredStores);
                } catch (e) {
                    console.error("ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:", e);
                }

                updateMap(filteredStores);
            }

            // â˜…â˜…â˜… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å…¨ä»¶è¡¨ç¤ºã™ã‚‹ â˜…â˜…â˜…
            filteredStores();

            document.getElementById("search-button").addEventListener("click", function(event) {
                event.preventDefault();
                filteredStores();
            });

            // åº—èˆ—ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®æŒ™å‹•
            document.querySelectorAll(".store-item").forEach((item, index) => {
                item.addEventListener("click", function() {
                    markers[index].marker.openPopup();  // ãƒ”ãƒ³ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
                    map.setView(markers[index].marker.getLatLng(), 17);  // ãƒãƒƒãƒ—ã‚’æ‹¡å¤§

                    highlightStore(index);  // åº—èˆ—ãƒªã‚¹ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
                });
            });

            // æŒ‡å®šã—ãŸåº—èˆ—ãƒªã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            function highlightStore(index) {
                document.querySelectorAll(".store-item").forEach(item => item.classList.remove("active"));
                var selectedItem = document.getElementById(`store-${index}`);
                selectedItem.classList.add("active");
                selectedItem.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });
    </script>
<a href="{% url 'home' %}">ãƒ›ãƒ¼ãƒ ç”»é¢ã¸</a>
{% endblock %}