{% extends 'base.html' %}
{% load static %}


{% block title %}マップ（検索結果）{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    {{ block.super }}  <!-- base.htmlのheadブロックを引き継ぐ -->
    <style>
        /* マップとリストを横並びに配置 */
        .map-container {
            display: flex;
            height: 80vh;  /* 画面の80％の高さ */
        }

        #map {
            width: 50%;
            height: 100%;
        }

        .store-list {
            width: 50%;
            height: 100%;
            overflow-y: auto; /* スクロール可能にする */
            padding: 10px;
            background-color: #f9f9f9;
        }

        .store-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .store-item.active {
            background-color: #ffeeba;   /* ピン選択時の強調表示 */
        }
    </style>
{% endblock%}

{% block content %}
    <h1>マップ（検索結果）画面</h1>

    <!-- マップとリストを横並びに -->
    <div class="map-container">
        <!-- マップ部分 -->
        <div id="map"></div>

        <!-- 店舗一覧部分 -->
        <div class="store-list" id="store-list">
            {% for store in stores %}
                <div class="store-item" id="store-{{ forloop.counter0 }}" data-index="{{ forloop.counter0 }}">
                    <strong>{{ store.store_name }}</strong><br>
                    {{ store.food_name }}<br>
                    ⭐️{{ store.rating }} | ¥{{ store.price }}
                </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- JSOnデータを埋め込み -->
    {{ stores|json_script:"stores-data" }}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var storesDataElement = document.getElementById("stores-data");
            var storesJson = storesDataElement.textContent.trim();
            var stores = JSON.parse(storesJson);         
                        
            // Leaflet.jsの地図を初期化
            var map = L.map('map', { zoomControl: true }).setView([35.6329, 139.8804], 15);
  
            // OpenStreetMapを利用
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var markers = [];

            // 店舗データを元にピンを追加
            stores.forEach((store, index) => {
                if (store.latitude && store.longitude) {
                    var marker = L.marker([store.latitude, store.longitude])
                        .addTo(map)
                        .bindPopup(`<strong>${store.store_name}</strong><br>${store.food_name}<br>評価: ${store.rating}⭐️<br>価格: ¥${store.price}`);

                    markers.push({ marker: marker, index:index });

                    // ピンがクリックされたら該当の店舗リストを選択・スクロール
                    marker.on("click", function() {
                        highlightStore(index);
                    });
                }
            });

            // 店舗リストをクリックしたときの挙動
            document.querySelectorAll(".store-item").forEach((item, index) => {
                item.addEventListener("click", function() {
                    markers[index].marker.openPopup();  // ピンのポップアップを開く
                    map.setView(markers[index].marker.getLatLng(), 17);  // マップを拡大

                    highlightStore(index);  // 店舗リストのハイライト処理
                });
            });

            // 指定した店舗リストをハイライトとスクロール
            function highlightStore(index) {
                document.querySelectorAll(".store-item").forEach(item => item.classList.remove("active"));
                var selectedItem = document.getElementById(`store-${index}`);
                selectedItem.classList.add("active");
                selectedItem.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });
    </script>

<p>データ数: {{ stores|length }}</p>

<a href="{% url 'home' %}">ホーム画面へ</a>
{% endblock %}