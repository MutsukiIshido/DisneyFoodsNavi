{% extends 'base.html' %}
{% load static %}


{% block title %}マップ（検索結果）{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    {{ block.super }}  <!-- base.htmlのheadブロックを引き継ぐ -->
{% endblock%}

{% block content %}
    <h1>マップ（検索結果）画面</h1>
    
    <div id="map" style="height: 500px; width: 100%;"></div>

    <!-- JSOnデータを埋め込み -->
    {{ stores|json_script:"stores-data" }}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Leaflet.jsの地図を初期化
            var map = L.map('map', { zoomControl: true }).setView([35.6329, 139.8804], 15);
  
            // OpenStreetMapを利用
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // // `map.on('load', ...)`を使ってマップの描画を修正
            map.on('load', function() {
                map.invalidateSize();
            });

            // 地図初期化後、少し遅らせてサイズを再計算する方法
            setTimeout(function() {
                map.invalidateSize();
            }, 500);

            // デバッグ用ログ
            console.log(document.getElementById("stores-data").textContent);

            // 店舗データをパース
            var storesDataElement = document.getElementById("stores-data");

            if (!storesDataElement) {
                console.error("stores-data element not found");
            } else{
                try {
                    var storesJson = storesDataElement.textContent.trim();
                    console.log("Raw stores JSON:", storesJson);  // JSONの中身を確認

                    if (!storesJson) {
                        console.warn("stores-data is empty.");
                    } else {
                        var stores = JSON.parse(storesJson);
                        console.log("Parsed stores:", stores);  // ここで型を確認

                        if (!Array.isArray(stores)) {
                            throw new Error("Parsed stores is not an array");
                        }

                        // マーカーを追加
                        stores.forEach(function(store) {
                            if (store.latitude && store.longitude) {
                                L.marker([store.latitude, store.longitude])
                                    .addTo(map)
                                    .bindPopup(`<strong>${store.store_name}</strong><br>${store.food_name}<br>評価: ${store.rating}⭐️<br>価格: ¥${store.price}`);
                            } else {
                                console.log("Invalid store location:", store);
                            }
                        });

                        // 店舗数を表示
                        document.getElementById("store-count").textContent = stores.length;
                    }
                } catch (error) {
                    console.error("JSON parse error:", error);
                }
            }
        });
    </script>

<p>データ数: {{ stores|length }}</p>

<a href="{% url 'home' %}">ホーム画面へ</a>
{% endblock %}