{% extends 'base.html' %}
{% load static %}

{% block title %}„É¨„Éì„É•„Éº‰∏ÄË¶ß{% endblock %}

{% block content %}
    <form method="get">
        <select name="category" id="category-select">
            <option value="">„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÈÅ∏Êäû</option>
            {% for category in categories %}
                <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.kind }}</option>
            {% endfor %}
        </select>
            
        <select name="food" id="food-select">
            <option value="">„Éï„Éº„Éâ„ÇíÈÅ∏Êäû</option>
            {% for food in foods %}
                <option value="{{ food.id }}" {% if selected_food == food.id|stringformat:"s" %}selected{% endif %}>{{ food.foods_name }}</option>
            {% endfor %}
        </select>

        <button type="button" id="filter-button">Áµû„ÇäËæº„Åø</button>
    </form>
    
    {% if reviews %}
        <div class="review-list">
            {% for review in reviews %}
                <div class="review-box">
                    <div class="review-content">
                        <div class="review-header">
                            <span class="review-user">üë§{{ review.user.nickname }}„Åï„Çì</span>
                        </div>
                        <p class="review-rating">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                ‚òÖ
                                {% else %}
                                ‚òÜ
                                {% endif %}
                            {% endfor %}
                        </p>

                        <p class="review-food-name">
                            <a href="{% url 'food_detail' review.food.id %}">
                                {{ review.food.foods_name }}
                            </a>
                        </p>
                                                
                        <p class="review-comment">{{ review.comment }}</p>
                        <a href="{% url 'review_detail' review.pk %}" class="more-link">„ÇÇ„Å£„Å®Ë¶ã„Çã</a>
                    </div>

                    {% if review.images.all %}
                        <div class="review-images">
                            {% for image in review.images.all|slice:":4" %}
                                <img src="{{ image.review_image_path.url }}" alt="„É¨„Éì„É•„ÉºÁîªÂÉè" class="thumbnail">
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="text-align: center; color: gray; margin-top: 30px;">„Åæ„Å†„É¨„Éì„É•„Éº„ÅØÊäïÁ®ø„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
    {% endif %}

{% endblock %}

{% block scripts %}
<script src="{% static 'js/main.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const categorySelect = document.getElementById("category-select");
    const foodSelect = document.getElementById("food-select");

    categorySelect.addEventListener("change", function() {
        const categoryId = this.value;

        foodSelect.innerHTML = '<option value="">„Éï„Éº„Éâ„ÇíÈÅ∏Êäû</option>';

        if (categoryId) {
            // „Ç´„ÉÜ„Ç¥„É™„Éº„ÅåÈÅ∏„Å∞„Çå„Å¶„ÅÑ„Çã„Å®„ÅçÔºà„ÅÑ„Å§„ÇÇ„ÅÆÂá¶ÁêÜÔºâ
            fetch("{% url 'foods_by_category' %}?category_id=" + categoryId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(food => {
                        const option = document.createElement('option');
                        option.value = food.id;
                        option.textContent = food.foods_name;
                        foodSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('„Ç®„É©„Éº:', error);
                });
        } else {
            // ‚òÖ „Ç´„ÉÜ„Ç¥„É™„ÉºÊú™ÈÅ∏Êäû„ÅÆ„Å®„ÅçÔºàÂÖ®ÈÉ®Ë°®Á§∫„Åô„ÇãÔºâ
            fetch("{% url 'foods_by_category' %}")  // „Ç´„ÉÜ„Ç¥„É™ID„Å™„Åó
                .then(response => response.json())
                .then(data => {
                    data.forEach(food => {
                        const option = document.createElement('option');
                        option.value = food.id;
                        option.textContent = food.foods_name;
                        foodSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('„Ç®„É©„Éº:', error);
                });
        }
    });

    document.getElementById("filter-button").addEventListener("click", function() {
        const selectedCategory = document.getElementById("category-select").value;
        const selectedFood = document.getElementById("food-select").value;

        let url = "/readingreview/?";

        if (selectedCategory) {
            url += `category=${selectedCategory}&`;
        }
        if (selectedFood) {
            url += `food=${selectedFood}`;
        }

        window.location.href = url;
    });
});
</script>
{% endblock %}